<div class="container">
  <mat-card>
    <mat-card-title>Booking</mat-card-title>
    <mat-card-content>
      <div *ngIf="isLoading" class="loading-indicator">
        <mat-spinner></mat-spinner>
        <p>Loading products...</p>
      </div>

      <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
      </div>

      <div class="products-container" *ngIf="!isLoading && !errorMessage && products.length > 0">
        <mat-accordion class="product-accordion">
          <mat-expansion-panel *ngFor="let product of products">
            <mat-expansion-panel-header>
              <mat-panel-title class="product-header">
                <img *ngIf="mainImageUrls[product.id!]" class="product-image" ngSrc="{{ mainImageUrls[product.id!] }}"
                  alt="{{ product.name }} image" width="60" height="60" />
                <div class="product-info">
                  <h3>{{ product.name }}</h3>
                  <p class="product-price">{{ product.price | currency:'KES':'symbol':'1.0-0' }}</p>
                </div>
              </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="product-details">
              <mat-form-field appearance="fill">
                <mat-label>Staff</mat-label>
                <mat-select [(ngModel)]="selectedStaffId[product.id!]" name="staff_{{product.id}}" required
                  #staffSelect="ngModel">
                  <mat-option [value]="null">-- Select Staff --</mat-option>
                  <mat-option *ngFor="let staff of staffList" [value]="staff.id">
                    {{ staff.firstName }} {{ staff.lastName }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="staffSelect.invalid && (staffSelect.dirty || staffSelect.touched)">
                  Please select a staff member.
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="fill">
                <mat-label>Customer</mat-label>
                <input matInput type="text" [(ngModel)]="customerInput[product.id!]"
                  (input)="onCustomerInputChange($event, product.id!)" (focus)="activeProductId = product.id!"
                  name="customerInput_{{product.id}}" placeholder="Select or Enter Customer" maxlength="100"
                  [matAutocomplete]="customerAuto" required #customerInputControl="ngModel" />
                <mat-autocomplete #customerAuto="matAutocomplete"
                  (optionSelected)="onCustomerSelect($event.option.value, product.id!)" autoActiveFirstOption>
                  <mat-option *ngFor="let customer of filteredCustomers[product.id!]" [value]="customer">
                    {{ customer.name }}
                  </mat-option>
                </mat-autocomplete>
                <mat-error
                  *ngIf="customerInputControl.invalid && (customerInputControl.dirty || customerInputControl.touched)">
                  Please select a customer or enter a new customer name.
                </mat-error>
              </mat-form-field>

              <mat-form-field>
                <input matInput placeholder="License Plate" [(ngModel)]="licensePlateInput[product.id!]"
                  (input)="onLicensePlateInputChange($event, product.id!)" (focus)="activeProductId = product.id!"
                  [matAutocomplete]="auto" #licensePlateControl="ngModel"> <mat-autocomplete #auto="matAutocomplete"
                  (optionSelected)="onLicensePlateSelect($event.option.value, product.id!)" autoActiveFirstOption>
                  <mat-option *ngFor="let vehicle of filteredVehicles[product.id!]" [value]="vehicle">
                    {{ vehicle.licensePlate }}
                  </mat-option>
                </mat-autocomplete>
              </mat-form-field>


              <mat-form-field appearance="fill">
                <mat-label>Price</mat-label>
                <input matInput type="number" [ngModel]="enteredPrice[product.id!]"
                  (ngModelChange)="onPriceChange($event, product.id!)" min="0" name="price_{{product.id}}"
                  placeholder="Enter Price" />
              </mat-form-field>

              <mat-form-field appearance="fill" class="notes-field">
                <mat-label>Notes</mat-label>
                <textarea matInput [(ngModel)]="notes[product.id!]" name="notes_{{product.id}}" maxlength="255"
                  placeholder="Add notes (optional)"></textarea>
              </mat-form-field>

              <button mat-raised-button color="primary" (click)="bookWash(product.id!)">Book Wash</button>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
      </div>

      <mat-paginator *ngIf="!isLoading && !errorMessage && products.length > 0" [length]="totalCount"
        [pageSize]="pageSize" [pageIndex]="pageIndex" [pageSizeOptions]="[4, 8, 12, 20]"
        (page)="handlePageEvent($event)" aria-label="Select page">
      </mat-paginator>

      <div *ngIf="!isLoading && !errorMessage && products.length === 0">
        <p>No products found.</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>